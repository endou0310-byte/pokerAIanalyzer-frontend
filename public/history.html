<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Â±•Ê≠¥ - Poker Analyzer</title>
  <link rel="icon" href="pwa-icons/icon-192.png" />
  <link rel="apple-touch-icon" href="pwa-icons/icon-192.png" />
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>
<script src="js/config.js"></script>
  <style>
    :root {
      --bg: #020408;
      --glass-base: rgba(13, 22, 35, 0.72);
      --glass-border: rgba(100, 149, 237, 0.15);
      --glass-highlight: rgba(255, 255, 255, 0.08);

      --text: #eef4ff;
      --muted: #94a3b8;
      --accent: #00d4ff;
      --accent-glow: rgba(0, 212, 255, 0.4);
      --radius: 20px;

      --font-family: "Inter", system-ui, -apple-system, sans-serif;
    }

    body {
      margin: 0;
      color: var(--text);
      font-family: var(--font-family);
      background-color: var(--bg);
      background-image:
        url('./noise.svg'),
        radial-gradient(circle at 50% 0%, #112240 0%, transparent 80%),
        radial-gradient(circle at 100% 0%, #0a1525 0%, transparent 50%);
      background-repeat: repeat, no-repeat, no-repeat;
      background-size: 100px 100px, 100% 100%, 100% 100%;
      min-height: 100vh;
      overflow-x: hidden; /* Prevent horizontal scroll */
    }

    /* Topbar matching App.jsx */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: rgba(5, 9, 16, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }
    
    @media (max-width: 600px) {
      .topbar {
        height: 56px;
        padding: 0 12px;
      }
      .logo-pill { font-size: 14px !important; margin-right: 6px !important; }
      .btn-nav { font-size: 11px !important; padding: 6px 10px !important; }
    }

    .logo-pill {
      font-size: 18px;
      font-weight: 800;
      color: #fff;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      text-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
      margin-right: 12px;
    }

    .top-title {
      font-size: 13px;
      color: var(--muted);
      opacity: 0.8;
      border-left: 1px solid rgba(255,255,255,0.15);
      padding-left: 12px;
      height: 20px;
      display: flex;
      align-items: center;
    }

    .btn-nav {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #e2e8f0;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-nav:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.4);
    }

    .page {
      max-width: 960px;
      margin: 32px auto 60px;
      padding: 0 20px;
    }

    .page h1 {
      font-size: 24px;
      font-weight: 800;
      margin: 0 0 8px;
      /* „ÉÜ„Ç≠„Çπ„Éà„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */
      background: linear-gradient(135deg, #fff 30%, #a4c8ff 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .page-desc {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    /* History List */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .history-empty {
      text-align: center;
      padding: 40px;
      color: var(--muted);
      font-size: 14px;
      background: var(--glass-base);
      border-radius: var(--radius);
      border: 1px solid var(--glass-border);
    }

    /* Item Card */
    .history-item {
      background: var(--glass-base);
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      border-top-color: rgba(100, 149, 237, 0.3);
      padding: 16px 20px;
      cursor: pointer;
      
      box-shadow: 
        inset 0 1px 0 0 var(--glass-highlight),
        0 4px 20px rgba(0,0,0,0.4);
        
      transition: all 0.2s ease;
    }

    .history-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
      background: rgba(18, 30, 48, 0.8);
      border-color: rgba(148, 210, 255, 0.3);
    }

    .h-title {
      font-size: 15px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 6px;
    }

    .h-sub {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .h-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .h-tag {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 99px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #cbd5e1;
    }

    /* Pager */
    .history-pager {
      margin-top: 24px;
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .pager-btn {
      min-width: 32px;
      height: 32px;
      padding: 0 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
      transition: 0.2s;
    }

    .pager-btn:hover:not([disabled]) {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .pager-btn[disabled] {
      opacity: 0.5;
      cursor: default;
    }

    /* Modal */
    .modal-outer {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-inner {
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;

      background: #0b121e; /* Solid dark base to prevent transparency issues */
      background: linear-gradient(180deg, rgba(16, 26, 41, 0.95), rgba(8, 14, 24, 0.98));
      
      border: 1px solid rgba(100, 149, 237, 0.25);
      border-radius: 20px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.9);
      overflow: hidden;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255,255,255,0.02);
    }

    .modal-header h2 {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      margin: 0;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: #fff;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.7;
      color: #d1d5db;
    }

    .modal-section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent);
      margin: 24px 0 8px;
    }
    .modal-section-title:first-child {
      margin-top: 0;
    }

    /* Modal Header Left Layout */
    .modal-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .modal-header h2 {
      margin: 0;
      white-space: nowrap; /* Prevent title wrap if possible */
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 250px;
    }

    .icon-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
      flex-shrink: 0;
      color: #94a3b8; /* Default muted */
    }
    .icon-btn:hover { 
      background: rgba(255,255,255,0.05);
    }
    
    .edit-btn { color: var(--accent); }
    .edit-btn:hover { 
      color: #fff; 
      transform: scale(1.1); 
      filter: drop-shadow(0 0 8px var(--accent-glow)); 
    }

    .delete-btn { color: #ef4444; }
    .delete-btn:hover { 
      color: #f87171; 
      transform: scale(1.1); 
      filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.5)); 
    }

    .btn-nav {
      white-space: nowrap; /* Prevent header buttons wrapping */
    }

    .analysis-text {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .analysis-text h2, .analysis-text h3 {
      color: #fff;
      margin-top: 16px;
      font-size: 15px;
    }

    /* Titles edit */


    .title-edit-input {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
    }

    /* Q&A */
    .qa-block {
      margin-top: 24px;
      border-top: 1px dashed rgba(255,255,255,0.1);
      padding-top: 16px;
    }
    .qa-msg {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
      margin-top: 4px;
    }
    .qa-role {
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
    }

    /* Share Button */
    .share-btn { 
      color: #10b981; 
    }
    .share-btn:hover { 
      color: #34d399; 
      transform: scale(1.1); 
      filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.5)); 
    }

    /* SNS Share Menu */
    .sns-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .sns-menu {
      background: linear-gradient(180deg, rgba(16, 26, 41, 0.95), rgba(8, 14, 24, 0.98));
      border: 1px solid rgba(100, 149, 237, 0.25);
      border-radius: 16px;
      padding: 20px;
      min-width: 280px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.9);
    }

    .sns-menu h3 {
      margin: 0 0 16px;
      font-size: 16px;
      color: #fff;
      text-align: center;
    }

    .sns-menu button {
      width: 100%;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .sns-menu button:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .sns-menu button:last-child {
      margin-bottom: 0;
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
    }

  </style>

</head>
<body>
  <!-- „Éò„ÉÉ„ÉÄ„Éº -->
  <header class="topbar">
    <div style="display: flex; align-items: center;">
      <div class="logo-pill">Poker Analyzer</div>
      <div class="top-title">Â±•Ê≠¥</div>
    </div>
    
    <div style="display: flex; align-items: center; gap: 12px;">
      <a href="index.html" class="btn-nav">
        <span>„Éè„É≥„ÉâË®òÈå≤</span>
      </a>
      <a href="#" id="logoutLink" class="btn-nav">
        <span>„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
      </a>
    </div>
  </header>

  <main class="page">
    <h1>Ëß£ÊûêÂ±•Ê≠¥</h1>
    <div class="page-desc">
      „Åì„Çå„Åæ„ÅßËß£Êûê„Åó„Åü„Éè„É≥„Éâ„ÅÆ‰∏ÄË¶ß„Åß„Åô„ÄÇË¶ãÂá∫„Åó„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅËß£ÊûêÂÜÖÂÆπ„Å®ËøΩ„ÅÑË≥™Âïè„ÅÆ„É≠„Ç∞„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ
    </div>

    <div id="historyList" class="history-list"></div>
    <div id="historyEmpty" class="history-empty" style="display:none;">
      „Åæ„Å†Ëß£ÊûêÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éè„É≥„Éâ„ÇíË®òÈå≤„Åó„Å¶Ëß£Êûê„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´‰∏ÄË¶ß„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
    </div>
    <!-- ‚ñº „Éö„Éº„Ç∏„É£ -->
    <div id="historyPager" class="history-pager"></div>
  </main>


  <!-- Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
  <div id="historyModalOuter" class="modal-outer">
    <div class="modal-inner">
<div class="modal-header">
  <div class="modal-header-left">
    <h2 id="modalTitle">Â±•Ê≠¥Ë©≥Á¥∞</h2>
    <!-- Edit Button (SVG) -->
    <button id="titleEditBtn" class="icon-btn edit-btn" type="button" title="ÂêçÂâç„ÇíÂ§âÊõ¥">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
    </button>
    <!-- Delete Button (SVG) -->
    <button id="historyDeleteBtn" class="icon-btn delete-btn" type="button" title="„Åì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    </button>
    <!-- Share Button (SVG) -->
    <button id="shareBtn" class="icon-btn share-btn" type="button" title="SNS„Åß„Ç∑„Çß„Ç¢">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM6 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM18 22a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"></path>
      </svg>
    </button>
  </div>
  <button id="modalClose" class="modal-close" aria-label="Èñâ„Åò„Çã">√ó</button>
</div>

      <div id="modalBody" class="modal-body"></div>
    </div>
  </div>

  <!-- SNS Share Menu -->
  <div id="snsMenuOverlay" class="sns-menu-overlay">
    <div class="sns-menu">
      <h3>üì§ SNS„Åß„Ç∑„Çß„Ç¢</h3>
      <button id="snsTwitter">ùïè (Twitter) „Åß„Ç∑„Çß„Ç¢</button>
      <button id="snsLine">LINE „Åß„Ç∑„Çß„Ç¢</button>
      <button id="snsDiscord">Discord „Åß„Ç∑„Çß„Ç¢</button>
      <button id="snsFacebook">Facebook „Åß„Ç∑„Çß„Ç¢</button>
      <button id="snsCancel">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script type="module">
    // -------- ÂÖ±ÈÄöÔºö„É≠„Ç∞„Ç§„É≥„ÉÅ„Çß„ÉÉ„ÇØ --------

    let user = null;
    try {
      user = JSON.parse(localStorage.getItem("pa_user") || "null");
      if (!user || !user.user_id) location.replace("login.html");
    } catch {
      location.replace("login.html");
    }

    // „É≠„Ç∞„Ç¢„Ç¶„Éà
    document.getElementById("logoutLink")?.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("pa_user");
      localStorage.removeItem("pa_plan");
      location.replace("login.html");
    });

    // -------- API Âü∫Êú¨ URL --------
  const API =
    (window.PA && window.PA.API_BASE) ||
    window.API_BASE ||
    "";

    const listEl = document.getElementById("historyList");
    const emptyEl = document.getElementById("historyEmpty");
    const modalOuter = document.getElementById("historyModalOuter");
    const modalBody = document.getElementById("modalBody");
    const modalTitle = document.getElementById("modalTitle");
    const modalClose = document.getElementById("modalClose");
    const pagerEl = document.getElementById("historyPager");
    const titleEditBtn = document.getElementById("titleEditBtn");

    // „Éö„Éº„Ç∏„É≥„Ç∞Áî®
    const PAGE_SIZE = 20;
    let allItems = [];
    let currentPage = 1;

    // „Çø„Ç§„Éà„É´Á∑®ÈõÜÁî®
    let currentTitle = "";
    let currentEditingId = null;
    let titleEditing = false;


    modalClose.onclick = () => { modalOuter.style.display = "none"; };
    modalOuter.onclick = (e) => {
      if (e.target === modalOuter) modalOuter.style.display = "none";
    };

    // ===== „Ç´„Éº„ÉâÂ§âÊèõ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ =====
    // ‰æã: "Ah" -> "A‚ô•"
    // ‰æã: "Ah" -> "<span style='color:...'>A‚ô•</span>"
    function convertCard(card) {
      if (!card || typeof card !== "string" || card.length < 2) return card;
      const rank = card.slice(0, card.length - 1);
      const suit = card.slice(-1).toLowerCase();
      
      let color = "#9ecbff"; // Default (Spades/Clubs) - Light Blue to match BoardPicker
      let suitChar = suit;
      
      if (suit === 'h') { 
        suitChar = "‚ô•"; 
        color = "#ff6b81"; // Red (Hearts)
      } else if (suit === 'd') { 
        suitChar = "‚ô¶"; 
        color = "#ff6b81"; // Red (Diamonds) - Matches BoardPicker
      } else if (suit === 'c') { 
        suitChar = "‚ô£"; 
        color = "#9ecbff"; // Blue (Clubs)
      } else if (suit === 's') { 
        suitChar = "‚ô†"; 
        color = "#9ecbff"; // Blue (Spades)
      }
      
      return `<span style="color:${color}; font-weight:bold;">${rank}${suitChar}</span>`;
    }

    // ‰æã: ["Ah","Kd"] -> "A‚ô• K‚ô¶"
    function convertCards(cards) {
      if (!Array.isArray(cards)) return "";
      return cards.map(convertCard).join(" ");
    }

    // -------- 1) Â±•Ê≠¥‰∏ÄË¶ßÂèñÂæó --------
    async function loadHistory() {
      listEl.innerHTML = "";
      emptyEl.style.display = "none";

      try {
        const res = await fetch(
          `${API}/history/list?user_id=${encodeURIComponent(user.user_id)}`
        );
        if (!res.ok) {
          console.error("history/list status:", res.status);
          emptyEl.textContent = "Â±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ";
          emptyEl.style.display = "block";
          return;
        }

const data = await res.json();
if (!data.ok || !Array.isArray(data.items)) {
  console.error("history/list payload:", data);
  emptyEl.textContent = "Â±•Ê≠¥„Éá„Éº„Çø„ÅÆÂΩ¢Âºè„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ";
  emptyEl.style.display = "block";
  return;
}

// ÂèñÂæó„Åó„ÅüÂÖ®‰ª∂„Çí‰øùÊåÅ„Åó„Å¶„ÄÅ„Éö„Éº„Ç∏Âçò‰Ωç„ÅßÊèèÁîª„Åô„Çã
allItems = data.items || [];
currentPage = 1;

if (!allItems.length) {
  emptyEl.style.display = "block";
  listEl.innerHTML = "";
  pagerEl.innerHTML = "";
  return;
}

// 1„Éö„Éº„Ç∏ÁõÆ„ÇíÊèèÁîª
renderHistoryPage();
      } catch (err) {
        console.error("loadHistory error:", err);
        emptyEl.textContent = "Â±•Ê≠¥„ÅÆÂèñÂæó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ";
        emptyEl.style.display = "block";
      }
    }
    // -------- „Éö„Éº„Ç∏„Åî„Å®„ÅÆÊèèÁîª --------
    function renderHistoryPage() {
      listEl.innerHTML = "";
      pagerEl.innerHTML = "";
      emptyEl.style.display = "none";

      if (!allItems.length) {
        emptyEl.style.display = "block";
        return;
      }

      const totalPages = Math.max(1, Math.ceil(allItems.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * PAGE_SIZE;
      const pageItems = allItems.slice(start, start + PAGE_SIZE);

      // ---- „É™„Çπ„ÉàÊú¨‰Ωì ----
      pageItems.forEach((item) => {
        const div = document.createElement("div");
        div.className = "history-item";

        const dt = item.created_at
          ? new Date(item.created_at).toLocaleString()
          : "";

        let heroLabel = "";
        let boardLabel = "";
        try {
          const snap =
            typeof item.snapshot === "string"
              ? JSON.parse(item.snapshot)
              : item.snapshot;

          if (snap && snap.hero) {
            const seat = snap.hero.seat || "";
            const cards = convertCards(snap.hero.cards || []);
            const stack = snap.hero.stack_bb ?? "";
            heroLabel =
              seat || cards || stack !== ""
                ? `Hero: ${seat} ${cards} / ${stack}bb`
                : "";
          }

          if (snap && snap.board) {
            const all = [];
            if (Array.isArray(snap.board.FLOP)) {
              all.push(...snap.board.FLOP.map(convertCard));
            }
            if (Array.isArray(snap.board.TURN)) {
              all.push(...snap.board.TURN.map(convertCard));
            }
            if (Array.isArray(snap.board.RIVER)) {
              all.push(...snap.board.RIVER.map(convertCard));
            }
            if (all.length) {
              boardLabel = `BOARD: ${all.join(" ")}`;
            }
          }
        } catch (e) {
          console.warn("snapshot parse error:", e);
        }

        const baseTitle =
          item.title && String(item.title).trim()
            ? String(item.title).trim()
            : `Hand #${item.hand_id || "-"}`;
        const title = item.title_override || baseTitle;
        const sub = dt || "";
        const tags = [];
        if (heroLabel) tags.push(heroLabel);
        if (boardLabel) tags.push(boardLabel);

        div.innerHTML = `
          <div class="h-title">${title}</div>
          ${sub ? `<div class="h-sub">${sub}</div>` : ""}
          ${
            tags.length
              ? `<div class="h-tags">${tags
                  .map((t) => `<span class="h-tag">${t}</span>`)
                  .join("")}</div>`
              : ""
          }
        `;

        div.onclick = () => openDetail(item.id, title);
        listEl.appendChild(div);
      });

      // ---- „Éö„Éº„Ç∏„É£ ----
      if (totalPages <= 1) {
        pagerEl.innerHTML = "";
        return;
      }

      const makeBtn = (label, page, disabled = false) => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.className = "pager-btn";
        if (disabled) {
          btn.disabled = true;
        } else {
          btn.addEventListener("click", () => {
            currentPage = page;
            renderHistoryPage();
          });
        }
        return btn;
      };

      // Ââç„Å∏
      pagerEl.appendChild(
        makeBtn("‚Äπ Ââç„Å∏", currentPage - 1, currentPage <= 1)
      );

      // „Éö„Éº„Ç∏Áï™Âè∑ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Á∞°ÊòìÁöÑ„Å´Ôºâ
      for (let p = 1; p <= totalPages; p++) {
        pagerEl.appendChild(
          makeBtn(String(p), p, p === currentPage)
        );
      }

      // Ê¨°„Å∏
      pagerEl.appendChild(
        makeBtn("Ê¨°„Å∏ ‚Ä∫", currentPage + 1, currentPage >= totalPages)
      );
    }

    // -------- 2) Â±•Ê≠¥Ë©≥Á¥∞ÂèñÂæó --------
    async function openDetail(id, title) {
      try {
        const res = await fetch(`${API}/history/detail?id=${encodeURIComponent(id)}`);
        if (!res.ok) {
          console.error("history/detail status:", res.status);
          return;
        }
        const data = await res.json();
        if (!data.ok || !data.history) {
          console.error("history/detail payload:", data);
          return;
        }

        const h = data.history;

        const dbTitle =
          h.title && typeof h.title === "string" && h.title.trim()
            ? h.title.trim()
            : null;

        currentEditingId = id;
        currentTitle = dbTitle || title || `Hand #${h.hand_id || "-"}`;
        titleEditing = false;
        modalTitle.textContent = currentTitle;
        
        // Store handId and snapshot for share functionality
        currentHandId = h.hand_id || null;
        try {
          currentSnapshot = typeof h.snapshot === 'string' ? JSON.parse(h.snapshot) : h.snapshot;
        } catch (e) {
          currentSnapshot = null;
        }
        
        const created = h.created_at
          ? new Date(h.created_at).toLocaleString()
          : "";

        // Ëß£ÊûêÊú¨ÊñáÔºàmarkdown or evaluationÔºâ
        const analysisText =
          (h.markdown && typeof h.markdown === "string" && h.markdown.trim()) ||
          (h.evaluation && typeof h.evaluation === "string" && h.evaluation.trim()) ||
          "Ëß£ÊûêÊú¨Êñá„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ";

        let html = "";

        if (created) {
          html += `<p style="font-size:11px;color:#aaa;margin-bottom:6px;">${created}</p>`;
        }

        html += `
          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:0;">
            <div class="modal-section-title" style="margin:0;">Ëß£ÊûêÁµêÊûú</div>
            <div id="shareBtnContainer"></div>
          </div>
        `;

        // Markdown „Çí HTML „Å´Â§âÊèõÔºàmarked „ÅåÂà©Áî®ÂèØËÉΩ„Å™„Çâ‰ΩøÁî®Ôºâ
        const analysisHtml =
          window.marked && window.marked.parse
            ? window.marked.parse(analysisText)
            : escapeHtml(analysisText).replace(/\n/g, "<br>");

        html += `<div class="analysis-text">${analysisHtml}</div>`;

// Q/A „É≠„Ç∞
if (h.conversation && Array.isArray(h.conversation) && h.conversation.length) {
  html += `<div class="qa-block">
    <div class="modal-section-title">Ë≥™Âïè„É≠„Ç∞</div>
  `;
  h.conversation.forEach((msg) => {
    if (!msg || !msg.role) return;

    const roleLabel = msg.role === "user" ? "Q" : "A";
    const content =
      typeof msg.message === "string" ? msg.message : JSON.stringify(msg.message);
    html += `
      <div class="qa-item">
        <div class="qa-role">${roleLabel}.</div>
        <div class="qa-msg">${escapeHtml(content)}</div>
      </div>
    `;
  });
  html += `</div>`;
}
        modalBody.innerHTML = html;
        
        // Move Share Button to Content Area
        const shareBtn = document.getElementById('shareBtn');
        const container = document.getElementById('shareBtnContainer');
        if (shareBtn && container) {
          container.appendChild(shareBtn);
          shareBtn.style.display = 'flex'; // Ensure it's visible
        }
        modalOuter.style.display = "flex";
      } catch (err) {
        console.error("openDetail error:", err);
      }
    }

    // -------- „Çø„Ç§„Éà„É´Á∑®ÈõÜ --------
    if (titleEditBtn) {
      titleEditBtn.addEventListener("click", () => {
        if (titleEditing) return;
        titleEditing = true;

        const input = document.createElement("input");
        input.type = "text";
        input.value = currentTitle || "";
        input.className = "title-edit-input";

        modalTitle.textContent = "";
        modalTitle.appendChild(input);
        input.focus();
        input.select();

        const finish = (commit) => {
          if (!titleEditing) return;
          titleEditing = false;

          if (commit) {
            let v = input.value.trim();
            if (!v) v = currentTitle || "";
            currentTitle = v || currentTitle || "";

            // „É¢„Éº„ÉÄ„É´„ÅÆ„Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
            modalTitle.textContent = currentTitle;

            // ‰∏ÄË¶ß„Éá„Éº„Çø(allItems)„ÇÇÊõ¥Êñ∞
            if (currentEditingId != null) {
              const item = allItems.find(
                (it) => String(it.id) === String(currentEditingId)
              );
              if (item) {
                item.title = currentTitle;         // DB„ÅÆÂÄ§„Å®„Åó„Å¶Êâ±„ÅÜ
                item.title_override = undefined;   // ‰∏ÄÊôÇ‰∏äÊõ∏„Åç„ÅØ‰∏çË¶Å
                renderHistoryPage();
              }

              // DB „Å´‰øùÂ≠òÔºàÂ§±Êïó„Åó„Å¶„ÇÇUI„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºâ
              saveTitle(currentEditingId, currentTitle).catch((err) => {
                console.error("saveTitle error:", err);
                alert("„Çø„Ç§„Éà„É´„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ");
              });
            }
          } else {
            // „Ç≠„É£„É≥„Çª„É´ ‚Üí ÂÖÉ„ÅÆ„Çø„Ç§„Éà„É´„Å´Êàª„Åô
            modalTitle.textContent = currentTitle || "";
          }
        };

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            finish(true);
          } else if (e.key === "Escape") {
            e.preventDefault();
            finish(false);
          }
        });

        input.addEventListener("blur", () => {
          finish(true);
        });
      });
    }
    async function saveTitle(id, title) {
      if (!user || !user.user_id) {
        throw new Error("user not found");
      }
      const res = await fetch(`${API}/history/update-title`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: user.user_id,
          id,
          title,
        }),
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`update-title failed: ${res.status} ${text}`);
      }

      const json = await res.json();
      if (!json.ok) {
        throw new Error(`update-title error: ${json.error || "unknown"}`);
      }
      return json;
    }

    // -------- Â±•Ê≠¥ÂâäÈô§ --------
    const historyDeleteBtn = document.getElementById("historyDeleteBtn");
    if (historyDeleteBtn) {
      historyDeleteBtn.addEventListener("click", async () => {
        if (!currentEditingId) {
          console.error("No currentEditingId");
          return;
        }
        if (!window.confirm("„Åì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ")) return;

        try {
          const res = await fetch(`${API}/history/delete_item`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: user.user_id, id: currentEditingId })
          });
          const json = await res.json();
          if (json.ok) {
            modalOuter.style.display = "none";
            loadHistory(); // Reload list
          } else {
            alert("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + (json.error || "Unknown"));
          }
        } catch (e) {
          alert("„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: " + e.message);
        }
      });
    }

    // -------- SNS Share Functionality --------
    let currentHandId = null;
    let currentSnapshot = null;
    let shareImageUrl = null;
    let isSharing = false;

    const snsMenuOverlay = document.getElementById('snsMenuOverlay');
    const shareBtn = document.getElementById('shareBtn');
    const snsCancel = document.getElementById('snsCancel');

    // Generate screenshot
    async function generateScreenshot() {
      if (!modalBody) return null;
      
      try {
        const canvas = await html2canvas(modalBody, {
          backgroundColor: '#0b121e',
          scale: 2,
          logging: false,
          useCORS: true,
        });
        
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const url = URL.createObjectURL(blob);
        return { blob, url };
      } catch (err) {
        console.error('Screenshot generation error:', err);
        return null;
      }
    }

    // Generate share text
    function generateShareText() {
      if (!currentSnapshot) {
        return {
          text: 'PokerAnalyzer„Åß„Éè„É≥„ÉâËß£ÊûêÔºÅ\nAI„Å´„Çà„ÇãÊà¶Áï•ÂàÜÊûê„Çí‰ΩìÈ®ì üéØ\n\n',
          url: 'https://pokeranalyzer.jp',
          hashtags: 'PokerAnalyzer,„Éù„Éº„Ç´„Éº,GTO'
        };
      }

      const parts = [];
      
      // Hand
      if (currentSnapshot.hero && currentSnapshot.hero.cards && currentSnapshot.hero.cards.length === 2) {
        const handStr = currentSnapshot.hero.cards.join(' ');
        parts.push(`üÉè Hand: ${handStr}`);
      }
      
      // Position
      if (currentSnapshot.hero && currentSnapshot.hero.seat) {
        parts.push(`üìç Position: ${currentSnapshot.hero.seat}`);
      }
      
      // Board
      if (currentSnapshot.board) {
        const boardCards = [];
        if (currentSnapshot.board.FLOP) boardCards.push(...currentSnapshot.board.FLOP);
        if (currentSnapshot.board.TURN) boardCards.push(...currentSnapshot.board.TURN);
        if (currentSnapshot.board.RIVER) boardCards.push(...currentSnapshot.board.RIVER);
        
        if (boardCards.length > 0) {
          parts.push(`üéØ Board: ${boardCards.join(' ')}`);
        }
      }

      const text = parts.length > 0 
        ? `PokerAnalyzer„Åß„Éè„É≥„ÉâËß£ÊûêÔºÅ\n\n${parts.join('\n')}\n\n`
        : 'PokerAnalyzer„Åß„Éè„É≥„ÉâËß£ÊûêÔºÅ\nAI„Å´„Çà„ÇãÊà¶Áï•ÂàÜÊûê„Çí‰ΩìÈ®ì üéØ\n\n';

      // Generate URL based on handId
      const url = currentHandId 
        ? `https://pokeranalyzer.jp/#/hand/${currentHandId}`
        : 'https://pokeranalyzer.jp';

      return {
        text,
        url,
        hashtags: 'PokerAnalyzer,„Éù„Éº„Ç´„Éº,GTO,Êà¶Áï•ÂàÜÊûê'
      };
    }

    // Share button click
    shareBtn.addEventListener('click', async () => {
      if (isSharing) return;
      
      isSharing = true;
      shareBtn.disabled = true;
      shareBtn.style.opacity = '0.5';
      
      // Generate screenshot
      const screenshot = await generateScreenshot();
      if (!screenshot) {
        alert('ÁîªÂÉè„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        isSharing = false;
        shareBtn.disabled = false;
        shareBtn.style.opacity = '1';
        return;
      }
      
      shareImageUrl = screenshot.url;
      
      // Check if Web Share API is available (mobile)
      if (navigator.share && navigator.canShare?.({ files: [new File([screenshot.blob], 'poker-analysis.png', { type: 'image/png' })] })) {
        try {
          const { text, url } = generateShareText();
          await navigator.share({
            title: 'PokerAnalyzer - „Éè„É≥„ÉâËß£ÊûêÁµêÊûú',
            text: text,
            url: url,
            files: [new File([screenshot.blob], 'poker-analysis.png', { type: 'image/png' })]
          });
          
          if (shareImageUrl) URL.revokeObjectURL(shareImageUrl);
          shareImageUrl = null;
          isSharing = false;
          shareBtn.disabled = false;
          shareBtn.style.opacity = '1';
          return;
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share failed:', err);
          }
        }
      }
      
      // Desktop: Show SNS menu
      snsMenuOverlay.style.display = 'flex';
      isSharing = false;
      shareBtn.disabled = false;
      shareBtn.style.opacity = '1';
    });

    // SNS menu handlers
    snsCancel.addEventListener('click', () => {
      snsMenuOverlay.style.display = 'none';
      if (shareImageUrl) {
        URL.revokeObjectURL(shareImageUrl);
        shareImageUrl = null;
      }
    });

    snsMenuOverlay.addEventListener('click', (e) => {
      if (e.target === snsMenuOverlay) {
        snsMenuOverlay.style.display = 'none';
        if (shareImageUrl) {
          URL.revokeObjectURL(shareImageUrl);
          shareImageUrl = null;
        }
      }
    });

    // Share to specific SNS
    async function shareToSNS(platform) {
      if (!shareImageUrl) return;
      
      const { text, url, hashtags } = generateShareText();
      
      // Download image first
      const a = document.createElement('a');
      a.href = shareImageUrl;
      a.download = 'poker-analysis.png';
      a.click();
      
      // Wait a moment then open SNS
      setTimeout(() => {
        let shareUrl = '';
        
        switch (platform) {
          case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}&hashtags=${encodeURIComponent(hashtags)}`;
            break;
          case 'line':
            shareUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text + url)}`;
            break;
          case 'discord':
            alert('ÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇDiscord„Å´Áõ¥Êé•ÊäïÁ®ø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            snsMenuOverlay.style.display = 'none';
            if (shareImageUrl) URL.revokeObjectURL(shareImageUrl);
            shareImageUrl = null;
            return;
          case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            break;
          default:
            break;
        }
        
        if (shareUrl) {
          window.open(shareUrl, '_blank', 'width=600,height=400');
        }
        
        snsMenuOverlay.style.display = 'none';
        if (shareImageUrl) URL.revokeObjectURL(shareImageUrl);
        shareImageUrl = null;
      }, 500);
    }

    document.getElementById('snsTwitter').addEventListener('click', () => shareToSNS('twitter'));
    document.getElementById('snsLine').addEventListener('click', () => shareToSNS('line'));
    document.getElementById('snsDiscord').addEventListener('click', () => shareToSNS('discord'));
    document.getElementById('snsFacebook').addEventListener('click', () => shareToSNS('facebook'));

    // -------- HTML „Ç®„Çπ„Ç±„Éº„Éó --------
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // ÂàùÊúü„É≠„Éº„Éâ
    loadHistory();
  </script>
</body>
</html>
